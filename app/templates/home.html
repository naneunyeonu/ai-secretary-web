{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 80px; z-index: 100;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">â• ë‚´ ìì‚° ì¶”ê°€</h5>
                </div>
                <div class="card-body">
                    <form id="portfolioForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ì¢…ëª© ì½”ë“œ (Ticker)</label>
                            <input type="text" id="p_ticker" class="form-control" placeholder="ì˜ˆ: VOO, GOOGL, 005930.KS" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">í‰ê·  ë‹¨ê°€</label>
                            <input type="number" step="any" id="p_avg_price" class="form-control" placeholder="ì˜ˆ: 312.95" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">ë³´ìœ  ì£¼ìˆ˜</label>
                            <input type="number" step="any" id="p_quantity" class="form-control" placeholder="ì˜ˆ: 3" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold">ì”ê³ ì— ì¶”ê°€í•˜ê¸°</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold mb-0">ğŸ’¼ ë‚´ ì”ê³ </h3>
                <button onclick="loadPortfolio()" class="btn btn-outline-secondary btn-sm">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            
            <div id="portfolioContainer" class="d-flex flex-column gap-3">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("access_token");

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì”ê³  ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded", loadPortfolio);

    // ìˆ«ìì— ì½¤ë§ˆ ì°ê³  ì†Œìˆ˜ì  ì²˜ë¦¬í•˜ëŠ” ë„êµ¬
    function formatNumber(num, currency) {
        if (currency === 'KRW') {
            return Math.round(num).toLocaleString('ko-KR'); // ì›í™”ëŠ” ì†Œìˆ˜ì  ì œê±°
        } else {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 }); // ë‹¬ëŸ¬ëŠ” ì†Œìˆ˜ì  ìœ ì§€
        }
    }

    // í¬íŠ¸í´ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸° API í˜¸ì¶œ
    async function loadPortfolio() {
        if (!token) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); window.location.href = "/login"; return; }
        
        const container = document.getElementById("portfolioContainer");
        
        try {
            const response = await fetch("/portfolio", { 
                headers: { "Authorization": "Bearer " + token } 
            });
            
            if (response.status === 401) { alert("ì„¸ì…˜ ë§Œë£Œ"); window.location.href = "/login"; return; }
            
            const items = await response.json();
            container.innerHTML = ""; 

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="card border-0 shadow-sm text-center py-5">
                        <h5 class="text-muted">ì•„ì§ ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</h5>
                        <p class="text-muted mb-0">ì™¼ìª½ì—ì„œ ë³´ìœ ì¤‘ì¸ ì£¼ì‹ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                    </div>`;
                return;
            }

            // ê° ì•„ì´í…œë³„ë¡œ ì¹´ë“œ ìƒì„±
            for (const item of items) {
                createPortfolioCard(item);
            }
        } catch (error) { 
            console.error("í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨:", error);
            container.innerHTML = `<div class="alert alert-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
        }
    }

    // ì¹´ë“œ UI ê·¸ë¦¬ê¸° (ë³´ì—¬ì£¼ì‹  ìŠ¤í¬ë¦°ìƒ· ìŠ¤íƒ€ì¼ ì ìš© âœ¨)
    function createPortfolioCard(item) {
        const container = document.getElementById("portfolioContainer");
        
        // ìˆ˜ìµë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í™”ì‚´í‘œ
        const isPositive = item.return_rate >= 0;
        const colorClass = isPositive ? "text-danger" : "text-primary"; // í•œêµ­ì‹: ì˜¤ë¥´ë©´ ë¹¨ê°•, ë‚´ë¦¬ë©´ íŒŒë‘
        const arrow = isPositive ? "â–²" : "â–¼";
        
        // ìˆ˜ìµê¸ˆ (í˜„ì¬í‰ê°€ê¸ˆì•¡ - ë§¤ìˆ˜ê¸ˆì•¡)
        const profit = item.current_valuation - item.purchase_amount;
        const profitSign = profit >= 0 ? "+" : "";

        // ì›í™” í™˜ì‚° í…ìŠ¤íŠ¸ (ë‹¬ëŸ¬ ì£¼ì‹ì¼ ê²½ìš°ë§Œ ë Œë”ë§)
        let krwText = "";
        if (item.currency === "USD" && item.krw_valuation) {
            krwText = `<div class="text-end text-muted mt-1" style="font-size: 0.85rem;">
                         (ì•½ ${formatNumber(item.krw_valuation, 'KRW')} ì›)
                       </div>`;
        }

        // [ìˆ˜ì •ëœ HTML êµ¬ì¡°]
    const html = `
        <div class="card shadow-sm border-0 mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3 border-bottom pb-3">
                    
                    <div>
                        <h5 class="fw-bold mb-1">${item.ticker}</h5>
                        <span class="text-muted" style="font-size: 0.9rem;">í˜„ê¸ˆ ${item.quantity}ì£¼</span>
                    </div>

                    <div class="d-flex align-items-start">
                        <div class="text-end me-2"> <h4 class="fw-bold mb-0">${formatNumber(item.current_valuation, item.currency)} <span class="fs-6">${item.currency}</span></h4>
                            <div class="${colorClass} fw-bold" style="font-size: 0.95rem;">
                                ${arrow} ${formatNumber(Math.abs(profit), item.currency)} (${profitSign}${item.return_rate.toFixed(2)}%)
                            </div>
                            ${krwText}
                        </div>
                        
                        <button class="btn btn-sm btn-outline-danger border-0 p-0 ms-1" style="line-height: 1; font-size: 0.8rem;" onclick="deletePortfolioItem(${item.id})">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>

                <div class="row g-2 text-muted" style="font-size: 0.9rem;">
                    <div class="col-6 d-flex justify-content-between">
                        <span>ë§¤ìˆ˜ê¸ˆì•¡</span>
                        <span class="text-dark fw-medium">${formatNumber(item.purchase_amount, item.currency)}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                        <span>í‰ê· ë‹¨ê°€</span>
                        <span class="text-dark fw-medium">${formatNumber(item.avg_price, item.currency)}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                        <span>í‰ê°€ê¸ˆì•¡</span>
                        <span class="text-dark fw-medium">${formatNumber(item.current_valuation, item.currency)}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                        <span>í˜„ì¬ê°€</span>
                        <span class="text-dark fw-medium">${formatNumber(item.current_price, item.currency)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    }

    // í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ê°€ ì´ë²¤íŠ¸
    document.getElementById("portfolioForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const ticker = document.getElementById("p_ticker").value.toUpperCase().trim();
        const avg_price = parseFloat(document.getElementById("p_avg_price").value);
        const quantity = parseFloat(document.getElementById("p_quantity").value);

        // ì¶”ê°€ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” (ë¡œë”© í‘œì‹œ)
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerText = "ì¶”ê°€ ì¤‘...";

        try {
            const response = await fetch("/portfolio", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + token 
                },
                body: JSON.stringify({ ticker: ticker, avg_price: avg_price, quantity: quantity })
            });

            if (response.ok) { 
                // ì„±ê³µ ì‹œ í¼ ì´ˆê¸°í™” ë° ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                document.getElementById("portfolioForm").reset();
                loadPortfolio(); 
            } else { 
                const err = await response.json(); 
                alert("ì¶”ê°€ ì‹¤íŒ¨: " + err.detail); 
            }
        } catch (error) { 
            console.error(error); 
            alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "ì”ê³ ì— ì¶”ê°€í•˜ê¸°";
        }
    });

    // í¬íŠ¸í´ë¦¬ì˜¤ ì‚­ì œ ì´ë²¤íŠ¸
    async function deletePortfolioItem(itemId) {
        if (!confirm("ì •ë§ ì´ ìì‚°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        try {
            const response = await fetch("/portfolio/" + itemId, { 
                method: "DELETE", 
                headers: { "Authorization": "Bearer " + token } 
            });
            
            if (response.ok) { 
                loadPortfolio(); // ì‚­ì œ ì„±ê³µ ì‹œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            } else {
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (error) { 
            console.error(error); 
        }
    }
</script>
{% endblock %}